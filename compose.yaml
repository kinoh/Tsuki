name: tsuki

services:
  # TypeScript/Mastra-based backend (replacing Rust app)
  core:
    image: tsuki-core:${GIT_HASH}
    build:
      context: .
      dockerfile: docker/core/Dockerfile
      target: runtime
      args:
        GIT_HASH: ${GIT_HASH}
    environment:
      NODE_ENV: production
      WEB_AUTH_TOKEN: ${WEB_AUTH_TOKEN}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      PROMPT_PRIVATE_KEY: ${PROMPT_PRIVATE_KEY}
      GCP_SERVICE_ACCOUNT_KEY: ${GCP_SERVICE_ACCOUNT_KEY}
      FCM_PROJECT_ID: ${FCM_PROJECT_ID}
      DATA_DIR: /data
      WEATHER_LOCATION_PATH: ${WEATHER_LOCATION_PATH}
      PROMETHEUS_BASE_URL: ${PROMETHEUS_BASE_URL}
      PROMETHEUS_BASIC_AUTH_USERNAME: ${PROMETHEUS_BASIC_AUTH_USERNAME}
      PROMETHEUS_BASIC_AUTH_PASSWORD: ${PROMETHEUS_BASIC_AUTH_PASSWORD}
      OPENAI_MODEL: gpt-4.1
      AGENT_NAME: tsuki
      PERMANENT_USERS: kino
      ADMIN_JS_TMP_DIR: /tmp/.adminjs
    volumes:
      - core-data:/data
    ports:
      - "2953:2953"
    restart: always
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').request({port: 2953, path: '/'}, (res) => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1)).end()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  memgraph-init:
    image: alpine:3.23
    command: sh -c "mkdir -p /data && chown -R 101:103 /data"
    volumes:
      - memgraph-data:/data
    restart: "no"

  memgraph:
    image: memgraph/memgraph
    command: ["--data-directory=/data"]
    volumes:
      # NOTE: Ensure /data is owned by uid 101 gid 103 (memgraph user).
      - memgraph-data:/data
    ports:
      - "7687:7687"
    depends_on:
      memgraph-init:
        condition: service_completed_successfully
    restart: always

  memgraph-lab:
    image: memgraph/lab
    environment:
      QUICK_CONNECT_MG_HOST: memgraph
      QUICK_CONNECT_MG_PORT: 7687
    ports:
      - "3000:3000"
    depends_on:
      - memgraph
    restart: always

volumes:
  core-data:
  memgraph-data:
